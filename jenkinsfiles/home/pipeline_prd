pipeline {
	agent any
	
    environment {
    	MAVEN_HOME = "/Users/mac/Desktop/maven"
    	JENKINS_HOME = "/Users/mac/Desktop/jenkins"
        DEPLOY_ENV = "$BUILD_ENV"
        GIT_CREDENTIALS_ID = "pigohno"
    }
    
    stages {
        stage('Checkout source') {
            steps {
                checkout scm: [$class: 'GitSCM',
                userRemoteConfigs: [[url: GIT_WEB_VIEW_URL, credentialsId: GIT_CREDENTIALS_ID ]],
                branches: [[name: GIT_BRANCH]]], poll: false
            }
        }
        
        stage('Build') {
            steps {
                script {
                    // Maven을 사용하여 빌드
                    sh "$MAVEN_HOME/bin/mvn clean package"
                }
            }
        }
        
        stage('Copy JAR') {
            steps {
                script {
                    // JAR 파일을 Jenkins workspace로 복사
                    sh 'mkdir -p $JENKINS_HOME/workspace/$PROJECT_NAME'
                    sh 'cp target/*.jar $JENKINS_HOME/workspace/$PROJECT_NAME/'
                    sh 'chmod +x $JENKINS_HOME/workspace/$PROJECT_NAME/*'
                }
            }
        }

        stage('Run') {
            steps {
                script {
					sh '$JENKINS_HOME/script/./pid_kill.sh $PROJECT_NAME $PROJECT_NAME'
					//archiveArtifacts '/Users/mac/Desktop/jenkins/workspace/com.story.ai/com.story.ai-0.0.1-SNAPSHOT.jar'
                    // JAR 파일 실행
                    //sh 'echo "서비스 시작"'
                    //sh 'nohup java -jar $JENKINS_HOME/workspace/$PROJECT_NAME/$PROJECT_NAME-$VERSION.jar > $JENKINS_HOME/workspace/$PROJECT_NAME/nohup.out >&1 & disown'
                    //sh '''
                    //	$JENKINS_HOME/script/./start_jar.sh $JENKINS_HOME/workspace/$PROJECT_NAME/$PROJECT_NAME-$VERSION.jar
                    //'''
                    //sh 'ps -ef | grep java'
                    //sh 'sleep 10'
                    //sh 'echo "서비스 종료"'
                    //sh 'nohup java -jar $JENKINS_HOME/workspace/$PROJECT_NAME/$PROJECT_NAME-$VERSION.jar > /dev/null 2>&1 &'
                    //sh 'sh -c "nohup /usr/bin/java -jar $JENKINS_HOME/workspace/$PROJECT_NAME/$PROJECT_NAME-$VERSION.jar &"'
                    //sh 'nohup $JENKINS_HOME/script/./start_jar.sh $JENKINS_HOME/workspace/$PROJECT_NAME/$PROJECT_NAME-$VERSION.jar &'
                }
            }
        }
    }
    post {
    	success {
    		sh '''
    			echo '0000' | -S sudo $JENKINS_HOME/script/./start_jar.sh $JENKINS_HOME/workspace/$PROJECT_NAME/$PROJECT_NAME-$VERSION.jar
    			sleep 2
    		'''
    	}
    }
}